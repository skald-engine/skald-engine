<!DOCTYPE html>
<html>
<head>
  <title></title>
  <script type="text/javascript" src="/build/lib/skald.min.js"></script>
</head>
<body>
  
  <h1>ECS test</h1>

  <p>The zombie must bounce on the screen. Use the left mouse click to add a random tint, or right mouse click to reset the tint.</p>

  <script>
    // Configuration ----------------------------------------------------------
    const VelocityComponent = sk.component({
      data: {
        speed: 50,
        directionX: Math.random()*2 - 1,
        directionY: Math.random()*2 - 1,
      },
      methods: {
        invertX: function() {
          this.directionX *= -1
        },
        invertY: function() {
          this.directionY *= -1
        }
      }
    })

    const BounceSystem = sk.system({
      check: function(entity) {
        return entity.hasComponent(VelocityComponent)
      },
      update: function(entities, delta) {
        for (let i=0; i<entities.length; i++) {
          let entity = entities[i]
          let vel = entity.getComponent(VelocityComponent)

          let width = entity.display.width*entity.display.scale.x
          let height = entity.display.height*entity.display.scale.y

          entity.display.x += vel.directionX*vel.speed*delta
          entity.display.y += vel.directionY*vel.speed*delta

          if (entity.display.x < width || entity.display.x > game.display.width-width) {
            vel.invertX()
          }
          if (entity.display.y < height || entity.display.y > game.display.height-height) {
            vel.invertY()
          }

          entity.display.x = sk.utils.clip(
            entity.display.x,
            width,
            game.display.width-width
          )
          entity.display.y = sk.utils.clip(
            entity.display.y,
            height,
            game.display.height-height
          )
        }
      }
    })

    const ColorizeSystem = sk.system({
      check: function(entity) {
        return entity.hasComponent(VelocityComponent)
      },
      update: function(entities, delta) {
        for (let i=0; i<entities.length; i++) {
          let entity = entities[i]
          let vel = entity.getComponent(VelocityComponent)

          if (this.game.mouse.isPressed(sk.BUTTON.LEFT)) {
            entity.display.tint = Math.round(Math.random()*16777215)
          }
          if (this.game.mouse.isPressed(sk.BUTTON.RIGHT)) {
            entity.display.tint = 0xFFFFFF
          }
        }
      }
    })

    const Hero = sk.entity({
      initialize: function() {
        this.display = new sk.display.AnimatedSprite()
        this.display.configure({
          spriteSheet: game.resources.get('zombie'),
          position: {
            x: game.display.halfWidth,
            y: game.display.halfHeight
          },
          anchor: {x:0.5, y:0.5},
          scale: {x:0.4, y:0.4}
        })

        this.addComponent(new VelocityComponent())
      }
    })


    const BaseScene = sk.scene({
      initialize: function() {
        this.addSystem(new BounceSystem())
        this.addSystem(new ColorizeSystem())

        this.hero = this.addEntity(new Hero())
      },

      update: function(delta) {
        this.hero.display.update(delta)
      }
    })

    // Game initialization ----------------------------------------------------
    let game = new sk.Game({
      resources: {basePath: '../../assets/'},
      display: {width: 400, height: 400},
      logger: {level: 'trace'},
      manifest: [
        {id: 'zombie', type: 'spriteSheet', url: 'spritesheets/zombie_walking.json'},
      ]
    }, BaseScene)
  </script>

</body>
</html>